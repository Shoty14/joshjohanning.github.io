<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Authorize and Restore Azure Artifacts NuGet Packages in GitHub Actions" /><meta name="author" content="Josh Johanning" /><meta property="og:locale" content="en" /><meta name="description" content="Authenticate to Azure Artifacts from GitHub Actions for builds and code scanning workflows" /><meta property="og:description" content="Authenticate to Azure Artifacts from GitHub Actions for builds and code scanning workflows" /><link rel="canonical" href="https://josh-ops.com/posts/authorize-azure-artifacts-in-github-actions/" /><meta property="og:url" content="https://josh-ops.com/posts/authorize-azure-artifacts-in-github-actions/" /><meta property="og:site_name" content="josh-ops" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-01-04T14:15:00-06:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Authorize and Restore Azure Artifacts NuGet Packages in GitHub Actions" /><meta name="twitter:site" content="@jjjettrain" /><meta name="twitter:creator" content="@Josh Johanning" /><meta name="google-site-verification" content="google-site-verification=eTIC71VhPBtwll8rNv7qlXud1yJh6E88No39MdcM_MI" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Josh Johanning"},"dateModified":"2022-02-17T13:56:36-06:00","datePublished":"2021-01-04T14:15:00-06:00","description":"Authenticate to Azure Artifacts from GitHub Actions for builds and code scanning workflows","headline":"Authorize and Restore Azure Artifacts NuGet Packages in GitHub Actions","mainEntityOfPage":{"@type":"WebPage","@id":"https://josh-ops.com/posts/authorize-azure-artifacts-in-github-actions/"},"url":"https://josh-ops.com/posts/authorize-azure-artifacts-in-github-actions/"}</script><title>Authorize and Restore Azure Artifacts NuGet Packages in GitHub Actions | josh-ops</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="josh-ops"><meta name="application-name" content="josh-ops"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/sample/headshot.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">josh-ops</a></div><div class="site-subtitle font-italic">A DevOps Blog</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/speaking/" class="nav-link"> <i class="fa-fw fas fa-comment ml-xl-3 mr-xl-3 unloaded"></i> <span>SPEAKING</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/joshjohanning" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/jjjettrain" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/joshua-johanning/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Authorize and Restore Azure Artifacts NuGet Packages in GitHub Actions</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Authorize and Restore Azure Artifacts NuGet Packages in GitHub Actions</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1609791300" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jan 4, 2021 </em> </span> <span> Updated <em class="" data-ts="1645127796" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Feb 17, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> Josh Johanning </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1182 words"> <em>6 min</em> read</span></div></div></div><div class="post-content"><h2 id="summary"><span class="mr-2">Summary</span><a href="#summary" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>While this post is geared towards Azure DevOps and Azure Artifacts, this approach will work for any third-party feed that requires authentication (like <a href="#artifactory">Artifactory</a>!).</p><p>I needed to be able to restore my NuGet packages hosted in an Azure Artifacts instance in a GitHub Action workflow. In Azure Pipelines, it’s relatively simple with the <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/packages/nuget-restore?view=azure-devops">Restore NuGet Packages</a> task. This task dynamically creates a NuGet config with the proper authentication details to Azure Artifacts. In GitHub Actions, there isn’t a native action readily available for us to accomplish this.</p><p>I tried the <a href="https://github.com/marketplace/actions/shubham90-nugetauth">shubham90-nugetauth</a> marketplace action, but I couldn’t get it to work. The inputs only called for the <code class="language-plaintext highlighter-rouge">azure-devops-org-url</code>, not a particular Artifact feed, so I wasn’t sure how it sets up the configuration for the feeds since an organization could have multiple NuGet feeds. There is another action that looks promising, <a href="https://github.com/marketplace/actions/github-nuget-private-source-authorisation">GitHub NuGet Private Source Authorisation</a>, but I decided to use the command line for increased flexibility.</p><p>What I did instead was borrow some of my scripting knowledge from my <a href="/posts/nuget-pusher-script/">NuGet Pusher</a> post to programmatically add my Azure Artifacts feed as a source (with credentials) and restore the solution. This is summarized with a few simple commands:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Auth NuGet</span>
  <span class="na">run</span><span class="pi">:</span> <span class="s">dotnet nuget add source ${{ env.nuget_feed_source }} --name ${{ env.nuget_feed_name }} --username az --password ${{ secrets.AZURE_DEVOPS_TOKEN }} --configfile ${{ env.nuget_config }}</span>
  
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Restore NuGet Packages</span>
  <span class="na">run</span><span class="pi">:</span> <span class="s">dotnet restore ${{ env.solution_file_path }}</span>
</pre></table></code></div></div><p>Notes:</p><ul><li>This should work with either .NET Core as well as full .NET Framework on both Linux and Windows<li>The <code class="language-plaintext highlighter-rouge">--configfile</code> argument is optional - if not specified, there is a <a href="https://docs.microsoft.com/en-us/nuget/consume-packages/configuring-nuget-behavior">hierarchy involved</a>:<ol><li>It will first try to use the <code class="language-plaintext filepath highlighter-rouge">NuGet.config</code> in the current working directory first<li>Next, it will use the local user <code class="language-plaintext filepath highlighter-rouge">NuGet.config</code> in <code class="language-plaintext filepath highlighter-rouge">%appdata%\NuGet\NuGet.Config</code> (Windows) or <code class="language-plaintext filepath highlighter-rouge">~/.nuget/NuGet.Config</code> (Linux/Mac, depending on distro)</ol><li>If the <code class="language-plaintext filepath highlighter-rouge">.sln</code> is in the root (or current working directory), you can simply run <code class="language-plaintext highlighter-rouge">dotnet restore</code> without the solution path as well<li>Reference the <a href="https://docs.microsoft.com/en-us/dotnet/core/tools/dotnet-nuget-add-source"><code class="language-plaintext highlighter-rouge">dotnet nuget add source</code></a> and <a href="https://docs.microsoft.com/en-us/dotnet/core/tools/dotnet-restore"><code class="language-plaintext highlighter-rouge">dotnet restore</code></a> docs for more information</ul><h2 id="setup"><span class="mr-2">Setup</span><a href="#setup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Let’s take a step back and add some things that are necessary to make this work.</p><ol><li>First, we have to <a href="https://docs.microsoft.com/en-us/azure/devops/organizations/accounts/use-personal-access-tokens-to-authenticate?view=azure-devops&amp;tabs=Windows#create-a-pat">generate an Azure DevOp Personal Access Token</a> to<li>Next, we have to <a href="https://docs.github.com/en/actions/security-guides/encrypted-secrets">create a secret</a> either at the repository or GitHub organization with an Azure DevOps PAT that has access to the Artifact feed. I called my secret: <code class="language-plaintext highlighter-rouge">AZURE_DEVOPS_TOKEN</code><li>For reusability and ease, let’s add in a few environment variables to the GitHub Action workflow:</ol><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="na">env</span><span class="pi">:</span>
  <span class="na">solution_file</span><span class="pi">:</span> <span class="s1">'</span><span class="s">My.Core.App.sln'</span>
  <span class="na">nuget_feed_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">My-Azure-Artifacts-Feed'</span>
  <span class="na">nuget_feed_source</span><span class="pi">:</span> <span class="s1">'</span><span class="s">https://pkgs.dev.azure.com/&lt;AZURE-DEVOPS-ORGANIZATION&gt;/_packaging/&lt;MY-AZURE-ARTIFACTS-FEED&gt;/nuget/v3/index.json'</span>
  <span class="na">nuget_config</span><span class="pi">:</span> <span class="s1">'</span><span class="s">.nuget/NuGet.Config'</span>
</pre></table></code></div></div><p>Note that my Azure Artifacts feed was scoped to the Organization level, the NuGet Feed Source url will be slightly different depending on if you used a Project feed. The source URL can be found by navigating to the Azure Artifacts feed and clicking the <strong>Connect to Feed</strong> button.</p><h2 id="complete-workflow"><span class="mr-2">Complete Workflow</span><a href="#complete-workflow" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Including the complete code scanning workflow for reference - the only bit custom here is the environment variables and the Auth NuGet and Restore NuGet Packages run commands:</p><div file=".github/workflows/codeql-analysis.yml" class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text=".github/workflows/codeql-analysis.yml"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre><td class="rouge-code"><pre><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">CodeQL"</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span> <span class="nv">main</span> <span class="pi">]</span>
  <span class="na">pull_request</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span> <span class="nv">main</span> <span class="pi">]</span>
  <span class="na">schedule</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">cron</span><span class="pi">:</span> <span class="s1">'</span><span class="s">19</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">2'</span>
  <span class="na">workflow_dispatch</span><span class="pi">:</span>  <span class="c1"># manual trigger</span>

<span class="na">env</span><span class="pi">:</span>
  <span class="na">solution_file</span><span class="pi">:</span> <span class="s1">'</span><span class="s">My.Core.App.sln'</span>
  <span class="na">nuget_feed_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">My-Azure-Artifacts-Feed'</span>
  <span class="na">nuget_feed_source</span><span class="pi">:</span> <span class="s1">'</span><span class="s">https://pkgs.dev.azure.com/&lt;AZURE-DEVOPS-ORGANIZATION&gt;/_packaging/&lt;MY-AZURE-ARTIFACTS-FEED&gt;/nuget/v3/index.json'</span>
  <span class="na">nuget_config</span><span class="pi">:</span> <span class="s1">'</span><span class="s">.nuget/NuGet.Config'</span>
  
<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">analyze</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Analyze</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">windows-latest</span>

    <span class="na">strategy</span><span class="pi">:</span>
      <span class="na">fail-fast</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">matrix</span><span class="pi">:</span>
        <span class="na">language</span><span class="pi">:</span> <span class="pi">[</span> <span class="s1">'</span><span class="s">csharp'</span> <span class="pi">]</span>

    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout repository</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>

    <span class="c1"># Initializes the CodeQL tools for scanning.</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Initialize CodeQL</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">github/codeql-action/init@v1</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">languages</span><span class="pi">:</span> <span class="s">${{ matrix.language }}</span>

    <span class="c1"># # If exists, remove existing AzDO NuGet source that doesn't have authentication</span>
    <span class="c1"># - name: Remove existing entry from NuGet config</span>
    <span class="c1">#   run: dotnet nuget remove source ${{ env.nuget_feed_name }} --configfile ${{ env.nuget_config }}</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Auth NuGet</span>
      <span class="na">run</span><span class="pi">:</span> <span class="s">dotnet nuget add source ${{ env.nuget_feed_source }} --name ${{ env.nuget_feed_name }} --username az --password ${{ secrets.AZURE_DEVOPS_TOKEN }} --configfile ${{ env.nuget_config }}</span>
     
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Restore NuGet Packages</span>
      <span class="na">run</span><span class="pi">:</span> <span class="s">dotnet restore ${{ env.solution_file_path }}</span>
    
    <span class="c1"># Autobuild attempts to build any compiled languages  (C/C++, C#, or Java).</span>
    <span class="c1"># If this step fails, then you should remove it and run the build manually (see below)</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Autobuild</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">github/codeql-action/autobuild@v1</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Perform CodeQL Analysis</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">github/codeql-action/analyze@v1</span>
</pre></table></code></div></div><h2 id="when-would-you-have-to-use-the-dotnet-sources-remove-command"><span class="mr-2">When would you have to use the dotnet sources remove command?</span><a href="#when-would-you-have-to-use-the-dotnet-sources-remove-command" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>You may have noticed a commented-out run command in the above workflow:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1"># If exists, remove existing AzDO NuGet source that doesn't have authentication</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Remove existing entry from NuGet config</span>
  <span class="na">run</span><span class="pi">:</span> <span class="s">dotnet nuget remove source ${{ env.nuget_feed_name }} --configfile ${{ env.nuget_config }}</span>
</pre></table></code></div></div><p>If your <code class="language-plaintext filepath highlighter-rouge">NuGet.config</code> already has an Azure DevOps entry, you will need to remove it with <a href="https://docs.microsoft.com/en-us/dotnet/core/tools/dotnet-nuget-remove-source">dotnet nuget remove source</a> otherwise you will likely see <code class="language-plaintext highlighter-rouge">401 Unauthorized</code> errors during the <code class="language-plaintext highlighter-rouge">dotnet restore</code>. This is because that entry doesn’t (or at least shouldn’t!) have any credentials associated with it committed into source control, so it essentially tries to access it anonymously and will fail.</p><p>Also, we have to remove it because we cannot add a sources entry to the <code class="language-plaintext filepath highlighter-rouge">NuGet.config</code> with the same name.</p><h2 id="improvement-ideas--notes"><span class="mr-2">Improvement Ideas / Notes</span><a href="#improvement-ideas--notes" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ol><li>If your solution does not contain a <code class="language-plaintext filepath highlighter-rouge">NuGet.config</code> file, you may have to create a temporary config file similar to how the <a href="https://github.com/microsoft/azure-pipelines-tasks/blob/master/Tasks/NuGetCommandV2/nugetrestore.ts#L136">NuGet Command task</a> works in Azure DevOps<ul><li>Alternatively, simply omitting the <code class="language-plaintext highlighter-rouge">--configfile</code> argument will use the <a href="https://docs.microsoft.com/en-us/nuget/consume-packages/configuring-nuget-behavior">local user</a> <code class="language-plaintext filepath highlighter-rouge">NuGet.config</code><li>Using the local <code class="language-plaintext filepath highlighter-rouge">NuGet.config</code> will certainly work with GitHub-hosted runners since it’s a fresh instance each time, but you may run into conflicts if you’re on a shared self-hosted runner<li>This <a href="https://github.com/marketplace/actions/github-nuget-private-source-authorisation">marketplace action</a> uses a <a href="https://github.com/StirlingLabs/GithubNugetAuthAction/blob/main/action.sh#L25:L34">local <code class="language-plaintext filepath highlighter-rouge">NuGet.config</code></a> by default</ul><li>The <code class="language-plaintext highlighter-rouge">Restore NuGet Packages</code> command might not be needed since the <code class="language-plaintext highlighter-rouge">Autobuild</code> action performs a restore as well - therefore one may also be able to remove the <code class="language-plaintext highlighter-rouge">solution_file</code> variable - but I always like to have an explicit task for restoring packages so I know exactly if that failed<li>If you the <code class="language-plaintext highlighter-rouge">Autobuild</code> Action does not successfully build your project for code scanning, you will have to build it manually. Using full .NET Framework, there is an additional action that you need to add to add MSBuild to the path (<a href="https://github.com/marketplace/actions/setup-msbuild"><code class="language-plaintext highlighter-rouge">microsoft/setup-msbuild@v1.1</code></a>). Also make sure to add the <code class="language-plaintext highlighter-rouge">/p:UseSharedCompilation=false</code> argument mentioned from <a href="https://docs.github.com/en/free-pro-team@latest/github/finding-security-vulnerabilities-and-errors-in-your-code/troubleshooting-the-codeql-workflow#no-code-found-during-the-build">Troubleshooting the CodeQL workflow: No code found during the build</a>. Here’s an example:</ol><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Add msbuild to PATH</span>
  <span class="na">uses</span><span class="pi">:</span> <span class="s">microsoft/setup-msbuild@v1.1</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MSBuild Solution</span>
  <span class="na">run</span><span class="pi">:</span> <span class="s">msbuild ${{ env.solution_file }} /p:Configuration=debug /p:UseSharedCompilation=false</span>
</pre></table></code></div></div><h2 id="artifactory"><span class="mr-2">Artifactory</span><a href="#artifactory" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>I’ve seen a few instances where a team is using an <a href="https://www.jfrog.com/confluence/display/JFROG/NuGet+Repositories#NuGetRepositories-NuGetAPIKeyAuthentication">API key to access Artifactory</a>, so the command is slightly different:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Auth NuGet</span>
  <span class="na">run</span><span class="pi">:</span> <span class="s">nuget setapikey admin:password -Source Artifactory</span>
  
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Restore NuGet Packages</span>
  <span class="na">run</span><span class="pi">:</span> <span class="s">dotnet restore ${{ env.solution_file_path }}</span>
</pre></table></code></div></div><p>Notes:</p><ul><li>The <code class="language-plaintext highlighter-rouge">-ConfigFile</code> argument can optionally be used to specify a <code class="language-plaintext filepath highlighter-rouge">NuGet.config</code> file<li>Reference the <a href="https://docs.microsoft.com/en-us/nuget/reference/cli-reference/cli-ref-setapikey"><code class="language-plaintext highlighter-rouge">nuget setapikey</code></a> docs for more information</ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/github/'>GitHub</a>, <a href='/categories/actions/'>Actions</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/azure-devops/" class="post-tag no-text-decoration" >Azure DevOps</a> <a href="/tags/nuget/" class="post-tag no-text-decoration" >NuGet</a> <a href="/tags/github/" class="post-tag no-text-decoration" >GitHub</a> <a href="/tags/github-actions/" class="post-tag no-text-decoration" >GitHub Actions</a> <a href="/tags/azure-artifacts/" class="post-tag no-text-decoration" >Azure Artifacts</a> <a href="/tags/artifactory/" class="post-tag no-text-decoration" >Artifactory</a> <a href="/tags/codeql/" class="post-tag no-text-decoration" >CodeQL</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Authorize+and+Restore+Azure+Artifacts+NuGet+Packages+in+GitHub+Actions+-+josh-ops&url=https%3A%2F%2Fjosh-ops.com%2Fposts%2Fauthorize-azure-artifacts-in-github-actions%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Authorize+and+Restore+Azure+Artifacts+NuGet+Packages+in+GitHub+Actions+-+josh-ops&u=https%3A%2F%2Fjosh-ops.com%2Fposts%2Fauthorize-azure-artifacts-in-github-actions%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fjosh-ops.com%2Fposts%2Fauthorize-azure-artifacts-in-github-actions%2F&text=Authorize+and+Restore+Azure+Artifacts+NuGet+Packages+in+GitHub+Actions+-+josh-ops" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fjosh-ops.com%2Fposts%2Fauthorize-azure-artifacts-in-github-actions%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/github-container-jobs/">Docker Container Jobs in GitHub Actions</a><li><a href="/posts/actions-runner-controller-without-cert-manager/">Configure actions-runner-controller without cert-manager</a><li><a href="/posts/azdo-commit-message-validator-and-pr-linker-github-action/">Azure DevOps Commit Message Validator and PR Linker GitHub Action</a><li><a href="/posts/azure-devops-migrate-work-items/">Azure DevOps: Migrate Work Items to New Organization / Project</a><li><a href="/posts/github-misc-scripts/">Miscellaneous GitHub API/GraphQL/CLI Automation Scripts</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/github/">GitHub</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/github-actions/">GitHub Actions</a> <a class="post-tag" href="/tags/pull-requests/">Pull Requests</a> <a class="post-tag" href="/tags/github-advanced-security/">GitHub Advanced Security</a> <a class="post-tag" href="/tags/scripts/">Scripts</a> <a class="post-tag" href="/tags/work-items/">Work Items</a> <a class="post-tag" href="/tags/branch-protection-rules/">Branch Protection Rules</a> <a class="post-tag" href="/tags/dependabot/">Dependabot</a> <a class="post-tag" href="/tags/codeql/">CodeQL</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/azdo-commit-message-validator-and-pr-linker-github-action/"><div class="card-body"> <em class="small" data-ts="1660759200" data-df="ll" > Aug 17, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Azure DevOps Commit Message Validator and PR Linker GitHub Action</h3><div class="text-muted small"><p> Overview I was with a client recently that was using GitHub for source control and GitHub Advanced Security, and Azure DevOps for Boards and Pipelines. Integrating GitHub with Azure DevOps is rela...</p></div></div></a></div><div class="card"> <a href="/posts/github-codeql-pr/"><div class="card-body"> <em class="small" data-ts="1608170400" data-df="ll" > Dec 16, 2020 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>GitHub: Block Pull Request if Code Scanning Alerts Are Found</h3><div class="text-muted small"><p> Overview After virtually attending GitHub Universe last week and watching the GitHub Advanced Security round-up and Catching vulnerabilities early with GitHub sessions, it got me thinking: How do ...</p></div></div></a></div><div class="card"> <a href="/posts/lap-around-github-advanced-security/"><div class="card-body"> <em class="small" data-ts="1659578400" data-df="ll" > Aug 3, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>A Lap Around GitHub Advanced Security (30m Video)</h3><div class="text-muted small"><p> Overview I realized that there wasn’t any content of me speaking on the internet, just blogging, so I thought I would at least create one! This is a video I created to explain the features of GitH...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/nuget-pusher-script/" class="btn btn-outline-primary" prompt="Older"><p>Quickly Migrate NuGet Packages to a New Feed in Bulk</p></a> <a href="/posts/reparent-work-items/" class="btn btn-outline-primary" prompt="Newer"><p>Azure DevOps: Bulk Reparent Work Items</p></a></div><script src="https://utteranc.es/client.js" repo="joshjohanning/joshjohanning.github.io" issue-term="title" crossorigin="anonymous" async> </script> <script type="text/javascript"> $(function() { const origin = "https://utteranc.es"; const iframe = "iframe.utterances-frame"; const lightTheme = "github-light"; const darkTheme = "github-dark"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } addEventListener("message", (event) => { let theme; /* credit to <https://github.com/utterance/utterances/issues/170#issuecomment-594036347> */ if (event.origin === origin) { /* page initial */ theme = initTheme; } else if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); } else { return; } const message = { type: "set-theme", theme: theme }; const utterances = document.querySelector(iframe).contentWindow; utterances.postMessage(message, origin); }); }); </script></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/joshjohanning">Josh Johanning</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/github/">GitHub</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/github-actions/">GitHub Actions</a> <a class="post-tag" href="/tags/pull-requests/">Pull Requests</a> <a class="post-tag" href="/tags/github-advanced-security/">GitHub Advanced Security</a> <a class="post-tag" href="/tags/scripts/">Scripts</a> <a class="post-tag" href="/tags/work-items/">Work Items</a> <a class="post-tag" href="/tags/branch-protection-rules/">Branch Protection Rules</a> <a class="post-tag" href="/tags/dependabot/">Dependabot</a> <a class="post-tag" href="/tags/codeql/">CodeQL</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-GE92ZJY22K"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-GE92ZJY22K'); }); </script>
