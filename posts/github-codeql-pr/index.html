<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="GitHub: Block Pull Request if Code Scanning Alerts Are Found" /><meta name="author" content="Josh Johanning" /><meta property="og:locale" content="en" /><meta name="description" content="Overview" /><meta property="og:description" content="Overview" /><link rel="canonical" href="https://josh-ops.com/posts/github-codeql-pr/" /><meta property="og:url" content="https://josh-ops.com/posts/github-codeql-pr/" /><meta property="og:site_name" content="josh-ops" /><meta property="og:image" content="https://josh-ops.com/assets/screenshots/2020-12-16-github-codeql-pr/pr.png" /><meta property="og:image:height" content="390" /><meta property="og:image:width" content="918" /><meta property="og:image:alt" content="Pull Request that is blocked because Code Scanning Alerts are found" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-12-16T20:00:00-06:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://josh-ops.com/assets/screenshots/2020-12-16-github-codeql-pr/pr.png" /><meta name="twitter:image:alt" content="Pull Request that is blocked because Code Scanning Alerts are found" /><meta property="twitter:title" content="GitHub: Block Pull Request if Code Scanning Alerts Are Found" /><meta name="twitter:site" content="@jjjettrain" /><meta name="twitter:creator" content="@Josh Johanning" /><meta name="google-site-verification" content="google-site-verification=eTIC71VhPBtwll8rNv7qlXud1yJh6E88No39MdcM_MI" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Josh Johanning"},"dateModified":"2022-07-01T15:39:30-05:00","datePublished":"2020-12-16T20:00:00-06:00","description":"Overview","headline":"GitHub: Block Pull Request if Code Scanning Alerts Are Found","image":{"width":918,"height":390,"alt":"Pull Request that is blocked because Code Scanning Alerts are found","url":"https://josh-ops.com/assets/screenshots/2020-12-16-github-codeql-pr/pr.png","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://josh-ops.com/posts/github-codeql-pr/"},"url":"https://josh-ops.com/posts/github-codeql-pr/"}</script><title>GitHub: Block Pull Request if Code Scanning Alerts Are Found | josh-ops</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="josh-ops"><meta name="application-name" content="josh-ops"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/sample/headshot.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">josh-ops</a></div><div class="site-subtitle font-italic">A DevOps Blog</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/speaking/" class="nav-link"> <i class="fa-fw fas fa-comment ml-xl-3 mr-xl-3 unloaded"></i> <span>SPEAKING</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/joshjohanning" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/jjjettrain" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/joshua-johanning/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>GitHub: Block Pull Request if Code Scanning Alerts Are Found</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>GitHub: Block Pull Request if Code Scanning Alerts Are Found</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1608170400" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Dec 16, 2020 </em> </span> <span> Updated <em class="" data-ts="1656707970" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jul 1, 2022 </em> </span><div class="mt-3 mb-3"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 918 390'%3E%3C/svg%3E" data-src="/assets/screenshots/2020-12-16-github-codeql-pr/pr.png" class="preview-img bg" alt="Pull Request that is blocked because Code Scanning Alerts are found" width="918" height="390" data-proofer-ignore><figcaption class="pt-2 pb-2">Pull Request that is blocked because Code Scanning Alerts are found</figcaption></div><div class="d-flex justify-content-between"> <span> By <em> Josh Johanning </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1901 words"> <em>10 min</em> read</span></div></div></div><div class="post-content"><h2 id="overview"><span class="mr-2">Overview</span><a href="#overview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>After virtually attending GitHub Universe last week and watching the <a href="https://www.youtube.com/watch?v=T_-Tn81b4lc">GitHub Advanced Security round-up</a> and <a href="https://www.youtube.com/watch?v=l2epzyytPGE">Catching vulnerabilities early with GitHub</a> sessions, it got me thinking: How do I block a pull request from being merged if the scans detect issues? I didn’t think the <a href="https://docs.github.com/en/free-pro-team@latest/github/finding-security-vulnerabilities-and-errors-in-your-code/enabling-code-scanning-for-a-repository#understanding-the-pull-request-checks">GitHub Docs</a> were incredibly straight forward on how this works.</p><p>I knew how to configure a branch protection rule in GitHub that enforces things such as a GitHub Action or Azure DevOps stage completes successfully, but what about code scanning? How configurable is it?</p><h2 id="how-to"><span class="mr-2">How To</span><a href="#how-to" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>If you already have a Code Scanning workflow configured, skip to step #7.</p><ol><li>The first thing you need is a public repository (GHAS is free for public repos) or a private repository with the GitHub Advanced Security license enabled<li>In the Security tab on the repository, navigate to ‘Code scanning alerts’ page<li>I’m using the native ‘CodeQL Analysis’ workflow by GitHub - there are 3rd party analysis engines here too!<li>Take a look at the workflow file - I didn’t need to make any changes, but one can modify the language matrix if you want/don’t want scans to run for a particular language<li>There’s an <code class="language-plaintext highlighter-rouge">Autobuild</code> step here that works most of the time, but for some repositories I found I had to build my app manually - further reading on <a href="https://docs.github.com/en/code-security/code-scanning/automatically-scanning-your-code-for-vulnerabilities-and-errors/configuring-the-codeql-workflow-for-compiled-languages#adding-build-steps-for-a-compiled-language">build steps for compiled languages</a><li>Commit the workflow to your branch and merge it into Main - for best results we want an initial scan in the default branch before we test out the PR process<li>Under the Settings tab in the repository, navigate to Branches<li>Create a <a href="https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/defining-the-mergeability-of-pull-requests/managing-a-branch-protection-rule#creating-a-branch-protection-rule">branch protection rule</a> for your default branch - check the ‘Require status checks to pass before merging’ box<li>If you used the GitHub CodeQL workflow, add the <code class="language-plaintext highlighter-rouge">CodeQL</code> status check and save the rule<ul><li>You don’t want the <code class="language-plaintext highlighter-rouge">Analyze (javascript)</code> status check; that just will show if the particular scan has completed, not that it found any vulnerabilities<li>If you don’t see the <code class="language-plaintext highlighter-rouge">CodeQL</code> to add as a status check to the branch protection, <strong>it won’t appear as an option until you initiate at least one PR on the repository that triggers and completes the entire CodeQL scan</strong> (meaning all of the <code class="language-plaintext highlighter-rouge">Analyze</code> jobs have finished) - as of December 2021, this is still an issue. It is vaguely alluded to in this <a href="https://docs.github.com/en/code-security/code-scanning/automatically-scanning-your-code-for-vulnerabilities-and-errors/setting-up-code-scanning-for-a-repository#understanding-the-pull-request-checks">tidbit in the documentation</a> - emphasis mine:<blockquote><ul><li>When the code scanning jobs complete, GitHub works out whether any alerts were added by the pull request and adds the “Code scanning results / TOOL NAME” entry to the list of checks. <strong>After code scanning has been performed at least once</strong>, you can click Details to view the results of the analysis.</ul></blockquote></ul></ol><p>Step #9 was the part I wasn’t originally confused on. The other entry (eg. <code class="language-plaintext highlighter-rouge">Analyze (javascript)</code>) is only the <em>scan job</em> for the corresponding language. It should succeed irregardless of if vulnerabilities are found. If it fails, the <code class="language-plaintext highlighter-rouge">autobuild</code> task might not be able to compile your code. The <a href="https://docs.github.com/en/code-security/code-scanning/automatically-scanning-your-code-for-vulnerabilities-and-errors/setting-up-code-scanning-for-a-repository#understanding-the-pull-request-checks">Understanding the pull request checks </a> GitHub documentation summarizes well.</p><p>After configuring the code scanning workflow and branch protection policy, you should be all set!</p><p><img data-src="/assets/screenshots/2020-12-16-github-codeql-pr/branch-protection-configuration.png" alt="branch protection policy configuration" class="shadow" data-proofer-ignore> <em>Branch Protection Policy with the CodeQL status check configured</em></p><h2 id="testing-it-out"><span class="mr-2">Testing It Out</span><a href="#testing-it-out" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Another thing the GitHub Docs do not do a good job of spelling out is that only <em>Errors</em> or a security severity level of <em>High or Higher</em> are going to fail the Pull Request status check. <em>Warnings</em>, out of the box, do not block the PR.</p><p>Alright, so let’s introduce an error…does anyone know of an easy vulnerability we can put in our code? Well neither do I, but we don’t have to with the help of our friend, the <a href="https://web.archive.org/web/20200929073843/https://help.semmle.com/wiki/label/js/path-problem">Semmle vulnerability database</a> (Note: The day before I wrote this, this link started redirecting to GitHub, but I found an archive.org link to use for the purposes of this demo).</p><p>I’m going to use an incorrect suffix vulnerability. The easiest way to introduce this is to: 1) make sure <code class="language-plaintext highlighter-rouge">javascript</code> is in the language matrix in our CodeQL workflow like so: <code class="language-plaintext highlighter-rouge">language: [ 'csharp', 'javascript' ]</code> and 2) check in a simple <code class="language-plaintext filepath highlighter-rouge">.js</code> file somewhere in the repository with the bad code:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="kd">function</span> <span class="nx">endsWith</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">let</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="nx">y</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">x</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="nx">y</span><span class="p">)</span> <span class="o">===</span> <span class="nx">x</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">y</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

<span class="p">}</span>
</pre></table></code></div></div><p>Make sure to commit this in a branch because we want to test out the PR flow!</p><p>Afterwards, create the PR and wait for the job to run:</p><p><img data-src="/assets/screenshots/2020-12-16-github-codeql-pr/pr.png" alt="blocked pr" class="shadow" data-proofer-ignore> <em>Pull Request that is blocked because of a code scanning vulnerability (note that I can still force merge since I am an Administrator)</em></p><p>Success! Or, failure, just as we wanted - the pull request cannot be merged because the <code class="language-plaintext highlighter-rouge">CodeQL</code> status check failed, meaning it detected a vulnerability in the code.</p><p>Once you fix the vulnerable code and re-push, all of the status checks will be successful and you are free to merge:</p><p><img data-src="/assets/screenshots/2020-12-16-github-codeql-pr/pr-passing.png" alt="passing pr" class="shadow" data-proofer-ignore> <em>Pull Request with passing status checks - no vulnerable code has been found</em></p><p>The fact that GitHub gives this away for free for all public repositories is incredible! There is a licensing upcharge for Enterprises, but the setup is so simple and integrations so robust makes it well worth it (and we’re only scratching the surface!).</p><h2 id="status-check-failure-configuration"><span class="mr-2">Status Check Failure Configuration</span><a href="#status-check-failure-configuration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>By default, the status check will only fail if there is an <em>Error</em> or a security severity level of <em>High or Higher</em> <em>High or Higher</em> vulnerability - <em>Warnings</em> or a security level of <em>Medium</em> will not fail the status check. However, we can use the <a href="https://github.blog/changelog/2021-06-03-control-which-code-scanning-alerts-cause-a-pull-request-check-to-fail/">Control which code scanning alerts cause a pull request check to fail</a> feature that was release in June 2021 to configure what alert level will fail the PR:</p><p><img data-src="/assets/screenshots/2020-12-16-github-codeql-pr/code-scanning-configuration.png" alt="defining-the-severities-causing-pull-request-check-failure" class="shadow" data-proofer-ignore> <em>Control which code scanning alerts cause a pull request check to fail</em></p><p>For more information, see the documentation for <a href="https://docs.github.com/en/code-security/code-scanning/automatically-scanning-your-code-for-vulnerabilities-and-errors/configuring-code-scanning#defining-the-severities-causing-pull-request-check-failure">Defining the severities causing pull request check failure</a>.</p><h2 id="summary"><span class="mr-2">Summary</span><a href="#summary" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Not allowing code that introduces vulnerabilities to be merged in the PR process is crucial to ensuring the integrity of our code. Blocking a PR that contains a code vulnerability is essentially THE use case of GitHub Advanced Security - we’re able to see right on our PR in GitHub that there’s a vulnerability, with the deep linking and integration that you would expect. Finding out about the issue at PR time shortens the feedback loop - we don’t have to scramble before a production deployment if your security scan is occurring too late in the process.</p><p>Even without the branch protection configured, the code scanning results will still show that <code class="language-plaintext highlighter-rouge">CodeQL</code> found a vulnerability, but without the branch protection we would be able to freely merge this into main: <img data-src="/assets/screenshots/2020-12-16-github-codeql-pr/pr-no-branch-protection.png" alt="pr with no branch protection" class="shadow" data-proofer-ignore> <em>Pull Request that shows a code vulnerability found, but since there is no branch protection on this repo, we are free to merge</em></p><p>This might be enough for some, but if we’re going to go through the exercise of creating a code scanning workflow, just as it’s a best practice to require at least one other approver on the PR before merging, we should require that there are no vulnerabilities being introduced as well. GitHub Advanced Security prides itself on limiting the signal vs noise ratio, so the chance of getting a ‘High’ vulnerability result that is a false positive is pretty minimal. And if you do get a false positive or a result you aren’t going to fix - just <a href="https://docs.github.com/en/code-security/code-scanning/automatically-scanning-your-code-for-vulnerabilities-and-errors/managing-code-scanning-alerts-for-your-repository#dismissing-or-deleting-alerts">dismiss</a> the alert.</p><p>Happy (secure) coding!</p><hr /><h2 id="extra-credit---analyzing-a-sarif-file"><span class="mr-2">Extra Credit - Analyzing a SARIF File</span><a href="#extra-credit---analyzing-a-sarif-file" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>I originally had this section in here to assist with blocking PR’s from results other than <em>Errors</em> (such as <em>Warnings</em>), but GitHub has <a href="#status-check-failure-configuration">implemented this feature now</a>. I will leave the section below as it might be useful in its own right if you are interested in deep-diving or debugging your <code class="language-plaintext highlighter-rouge">SARIF</code> results file.</p><h3 id="original-content---analyzing-a-sarif-results-file-manually"><span class="mr-2">Original Content - Analyzing a SARIF Results File Manually</span><a href="#original-content---analyzing-a-sarif-results-file-manually" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Okay, what if we were to have a repository with Terraform code and used the ShiftLeft Analysis marketplace code scanning workflow? Or, we used the native GitHub CodeQL workflow but want it to block merges when it finds any result, including warnings?</p><p>Well, in the case of the ShiftLeft Analysis workflow, there is a <a href="https://slscan.io/en/latest/integrations/tips/#config-file">config file</a> that can be uploaded to the root of the repository to define some of this, but I haven’t played around much for this. For the GitHub CodeQL workflow, there is no fine-tuning configuration file that we can easily use (that I know of at this date).</p><p>For this, I wrote a script that examines the <code class="language-plaintext filepath highlighter-rouge">.sarif</code> and added another job to the workflow, like so:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre><td class="rouge-code"><pre>  <span class="na">Detect-Errors</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">strategy</span><span class="pi">:</span>
      <span class="na">fail-fast</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">matrix</span><span class="pi">:</span>
        <span class="na">language</span><span class="pi">:</span> <span class="pi">[</span> <span class="s1">'</span><span class="s">csharp'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">javascript'</span> <span class="pi">]</span>
    <span class="na">needs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">analyze</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Download Sarif Report</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/download-artifact@v2</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">sarif-report</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Detect Errors</span>
      <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">repo=$(echo ${{ github.repository }} | awk -F'/' '{print $2}')</span>
        <span class="s">results=$(cat $repo/results/${{ matrix.language }}-builtin.sarif | jq -r '.runs[].results[].ruleId')</span>

        <span class="s">resultsArray=($results)</span>
        
        <span class="s">echo "${resultsArray[*]}"</span>

        <span class="s">errorCount=0</span>
        <span class="s">warningCount=0</span>
        <span class="s">noteCount=0</span>

        <span class="s">for var in "${resultsArray[@]}"</span>
        <span class="s">do</span>
          <span class="s">severity=$(cat $repo/results/${{ matrix.language }}-builtin.sarif | jq -r '.runs[].tool.driver.rules[] | select(.id=="'$var'").properties."problem.severity"')</span>
          <span class="s">echo "${var} | $severity"</span>
          <span class="s">if [ "$severity" == "warning" ]; then let warningCount+=1; fi</span>
          <span class="s">if [ "$severity" == "error" ]; then let errorount+=1; fi</span>
          <span class="s">if [ "$severity" == "note" ]; then let noteount+=1; fi</span>
        <span class="s">done</span>

        <span class="s">echo ""</span>
        <span class="s">echo "Error Count: $errorCount"</span>
        <span class="s">echo "Warning Count: $warningCount"</span>
        <span class="s">echo "Note Count: $noteCount"</span>
        <span class="s">echo ""</span>

        <span class="s">if (( $errorCount &gt; 0 )); then</span>
            <span class="s">echo "errors found - failing detect error check..."</span>
            <span class="s">exit -1</span>
        <span class="s">fi</span>

        <span class="s">if (( $warningCount &gt; 0 )); then</span>
            <span class="s">echo "warnings found - failing detect warning check..."</span>
            <span class="s">exit -1</span>
        <span class="s">fi</span>
</pre></table></code></div></div><p>This will fail if any findings were found, including warnings - modify the script as needed.</p><p>Note that we also have to add an <code class="language-plaintext highlighter-rouge">Upload Build Artifact</code> step in the <code class="language-plaintext highlighter-rouge">Analyze</code> job, like so:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Upload Sarif Report to Workflow</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/upload-artifact@v2</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">sarif-report-${{ matrix.language }}</span>
        <span class="na">path</span><span class="pi">:</span> <span class="s">/home/runner/work/**/*.sarif</span>
</pre></table></code></div></div><p>Depending on the workflow, you may have to modify the <code class="language-plaintext highlighter-rouge">path</code> in the Upload task as well as the script. You can find out the relative path of the .sarif report by viewing the Actions’ logs.</p><p>The entire workflow can be found in my <a href="https://github.com/joshjohanning/tailspin-spacegame-web-deploy/blob/2d4955b668ffde45a2f4ea6e742268a536249b27/.github/workflows/codeql-analysis.yml">GitHub branch</a>.</p><p>Because the <code class="language-plaintext filepath highlighter-rouge">.sarif</code> produced by the ShiftLeft analysis is slightly different and by default <em>doesn’t</em> fail the job even with <em>errors</em>, I created a different workflow you can use to block pull requests if errors or warnings are found - see for <a href="https://github.com/joshjohanning/azdo-terraform-tailspin/blob/05151b64818db1c4cabf5aaf51f0024c779d81f5/.github/workflows/shiftleft-analysis.yml">example</a>.</p><p>Now just like we did above, we can modify our branch rule to require the “Detect-Errors” job to finish successfully, as this job will run successfully if there are no errors/warnings.</p><p><img data-src="/assets/screenshots/2020-12-16-github-codeql-pr/pr-detected-errors.png" alt="pr-detected-errors-job" class="shadow" data-proofer-ignore> <em>Adding the new job to the required status check list</em> <img data-src="/assets/screenshots/2020-12-16-github-codeql-pr/pr-blocked.png" alt="pr-blocked" class="shadow" data-proofer-ignore> <em>Pull Request that is blocked because of a ‘warning’ result found in the code scanning results</em></p><p>I’m sure there is probably a better way to do this (using the API or GraphQL endpoint?). I know back in the LGTM / Semmle days, there was also a config file you could commit to the root of the repository to more precisely define rules. Either way, let me know in the comments if you have any other ideas or improvements!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/github/'>GitHub</a>, <a href='/categories/advanced-security/'>Advanced Security</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/github/" class="post-tag no-text-decoration" >GitHub</a> <a href="/tags/github-actions/" class="post-tag no-text-decoration" >GitHub Actions</a> <a href="/tags/pull-requests/" class="post-tag no-text-decoration" >Pull Requests</a> <a href="/tags/codeql/" class="post-tag no-text-decoration" >CodeQL</a> <a href="/tags/github-advanced-security/" class="post-tag no-text-decoration" >GitHub Advanced Security</a> <a href="/tags/policy-enforcement/" class="post-tag no-text-decoration" >Policy Enforcement</a> <a href="/tags/branch-protection-rules/" class="post-tag no-text-decoration" >Branch Protection Rules</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=GitHub%3A+Block+Pull+Request+if+Code+Scanning+Alerts+Are+Found+-+josh-ops&url=https%3A%2F%2Fjosh-ops.com%2Fposts%2Fgithub-codeql-pr%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=GitHub%3A+Block+Pull+Request+if+Code+Scanning+Alerts+Are+Found+-+josh-ops&u=https%3A%2F%2Fjosh-ops.com%2Fposts%2Fgithub-codeql-pr%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fjosh-ops.com%2Fposts%2Fgithub-codeql-pr%2F&text=GitHub%3A+Block+Pull+Request+if+Code+Scanning+Alerts+Are+Found+-+josh-ops" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fjosh-ops.com%2Fposts%2Fgithub-codeql-pr%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/github-container-jobs/">Docker Container Jobs in GitHub Actions</a><li><a href="/posts/actions-runner-controller-without-cert-manager/">Configure actions-runner-controller without cert-manager</a><li><a href="/posts/azdo-commit-message-validator-and-pr-linker-github-action/">Azure DevOps Commit Message Validator and PR Linker GitHub Action</a><li><a href="/posts/azure-devops-migrate-work-items/">Azure DevOps: Migrate Work Items to New Organization / Project</a><li><a href="/posts/github-misc-scripts/">Miscellaneous GitHub API/GraphQL/CLI Automation Scripts</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/github/">GitHub</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/github-actions/">GitHub Actions</a> <a class="post-tag" href="/tags/pull-requests/">Pull Requests</a> <a class="post-tag" href="/tags/github-advanced-security/">GitHub Advanced Security</a> <a class="post-tag" href="/tags/scripts/">Scripts</a> <a class="post-tag" href="/tags/work-items/">Work Items</a> <a class="post-tag" href="/tags/branch-protection-rules/">Branch Protection Rules</a> <a class="post-tag" href="/tags/dependabot/">Dependabot</a> <a class="post-tag" href="/tags/codeql/">CodeQL</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/lap-around-github-advanced-security/"><div class="card-body"> <em class="small" data-ts="1659578400" data-df="ll" > Aug 3, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>A Lap Around GitHub Advanced Security (30m Video)</h3><div class="text-muted small"><p> Overview I realized that there wasn’t any content of me speaking on the internet, just blogging, so I thought I would at least create one! This is a video I created to explain the features of GitH...</p></div></div></a></div><div class="card"> <a href="/posts/dependency-review-action/"><div class="card-body"> <em class="small" data-ts="1649275200" data-df="ll" > Apr 6, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>GitHub: Block Pull Requests if a Vulnerable Dependency is Added</h3><div class="text-muted small"><p> Overview GitHub has added a new Dependency Review action to help keep vulnerable dependencies out of your repository! One of the complaints with the way Dependabot Security Alerts works in GitHub ...</p></div></div></a></div><div class="card"> <a href="/posts/azdo-commit-message-validator-and-pr-linker-github-action/"><div class="card-body"> <em class="small" data-ts="1660759200" data-df="ll" > Aug 17, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Azure DevOps Commit Message Validator and PR Linker GitHub Action</h3><div class="text-muted small"><p> Overview I was with a client recently that was using GitHub for source control and GitHub Advanced Security, and Azure DevOps for Boards and Pipelines. Integrating GitHub with Azure DevOps is rela...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/extends-template/" class="btn btn-outline-primary" prompt="Older"><p>Azure DevOps: Extends Template with Build and Deployment Templates</p></a> <a href="/posts/nuget-pusher-script/" class="btn btn-outline-primary" prompt="Newer"><p>Quickly Migrate NuGet Packages to a New Feed in Bulk</p></a></div><script src="https://utteranc.es/client.js" repo="joshjohanning/joshjohanning.github.io" issue-term="title" crossorigin="anonymous" async> </script> <script type="text/javascript"> $(function() { const origin = "https://utteranc.es"; const iframe = "iframe.utterances-frame"; const lightTheme = "github-light"; const darkTheme = "github-dark"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } addEventListener("message", (event) => { let theme; /* credit to <https://github.com/utterance/utterances/issues/170#issuecomment-594036347> */ if (event.origin === origin) { /* page initial */ theme = initTheme; } else if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); } else { return; } const message = { type: "set-theme", theme: theme }; const utterances = document.querySelector(iframe).contentWindow; utterances.postMessage(message, origin); }); }); </script></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/joshjohanning">Josh Johanning</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/github/">GitHub</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/github-actions/">GitHub Actions</a> <a class="post-tag" href="/tags/pull-requests/">Pull Requests</a> <a class="post-tag" href="/tags/github-advanced-security/">GitHub Advanced Security</a> <a class="post-tag" href="/tags/scripts/">Scripts</a> <a class="post-tag" href="/tags/work-items/">Work Items</a> <a class="post-tag" href="/tags/branch-protection-rules/">Branch Protection Rules</a> <a class="post-tag" href="/tags/dependabot/">Dependabot</a> <a class="post-tag" href="/tags/codeql/">CodeQL</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-GE92ZJY22K"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-GE92ZJY22K'); }); </script>
