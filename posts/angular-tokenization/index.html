<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Tokenizing Angular Environment Configuration in Azure DevOps" /><meta name="author" content="Josh Johanning" /><meta property="og:locale" content="en" /><meta name="description" content="Using the ‘build once deploy many’ concepts with an Angular application and Azure Pipelines" /><meta property="og:description" content="Using the ‘build once deploy many’ concepts with an Angular application and Azure Pipelines" /><link rel="canonical" href="https://josh-ops.com/posts/angular-tokenization/" /><meta property="og:url" content="https://josh-ops.com/posts/angular-tokenization/" /><meta property="og:site_name" content="josh-ops" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-06-17T18:30:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Tokenizing Angular Environment Configuration in Azure DevOps" /><meta name="twitter:site" content="@jjjettrain" /><meta name="twitter:creator" content="@Josh Johanning" /><meta name="google-site-verification" content="google-site-verification=eTIC71VhPBtwll8rNv7qlXud1yJh6E88No39MdcM_MI" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Josh Johanning"},"dateModified":"2022-04-12T21:39:21-05:00","datePublished":"2021-06-17T18:30:00-05:00","description":"Using the ‘build once deploy many’ concepts with an Angular application and Azure Pipelines","headline":"Tokenizing Angular Environment Configuration in Azure DevOps","mainEntityOfPage":{"@type":"WebPage","@id":"https://josh-ops.com/posts/angular-tokenization/"},"url":"https://josh-ops.com/posts/angular-tokenization/"}</script><title>Tokenizing Angular Environment Configuration in Azure DevOps | josh-ops</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="josh-ops"><meta name="application-name" content="josh-ops"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/sample/headshot.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">josh-ops</a></div><div class="site-subtitle font-italic">A DevOps Blog</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/speaking/" class="nav-link"> <i class="fa-fw fas fa-comment ml-xl-3 mr-xl-3 unloaded"></i> <span>SPEAKING</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/joshjohanning" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/jjjettrain" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/joshua-johanning/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Tokenizing Angular Environment Configuration in Azure DevOps</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Tokenizing Angular Environment Configuration in Azure DevOps</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1623972600" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jun 17, 2021 </em> </span> <span> Updated <em class="" data-ts="1649817561" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Apr 12, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> Josh Johanning </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1375 words"> <em>7 min</em> read</span></div></div></div><div class="post-content"><h2 id="overview"><span class="mr-2">Overview</span><a href="#overview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>I was working with a team that had an Angular front-end application and I was tasked with improving their CI/CD process. They had some automated pipelines, but they were running a build before each environment by running a different <code class="language-plaintext highlighter-rouge">npm run build -- --prod --configuration &lt;env&gt;</code> command.</p><p>My co-worker Colin Dembovsky summarizes it well in a <a href="https://colinsalmcorner.com/managing-config-for-net-core-web-app-deployments-with-tokenizer-and-replacetokens-tasks/">similar post for .NET Core</a>:</p><blockquote><p><strong>The Build Once Principle</strong></p><p>If you’ve ever read any of my blogs you’ll know I’m a proponent of the “build once” principle. That is, your build should be taking source code and (after testing and code analysis etc.) producing a single package that can be deployed to multiple environments. The biggest challenge with a “build once” approach is that it’s non-trivial to manage configuration. If you’re building a single package, how do you deploy it to multiple environments when the configuration is different on those environments?</p></blockquote><p>Basically, if you’re running a new build for each environment, you might as well not do any tests after your Dev build because there’s no way you can guarantee that the binaries build for Dev are the same as the ones going into Production. Never mind that it’s inefficient and wastes time - you already compiled your code once, why do it again? The only things that should differ between environments should be the environment-specific configuration (such as a connection string, or in my case, the back-end API url).</p><p>I’m taking the concepts from that post and my experience with a few other clients and will be doing something very similar to that here!</p><h2 id="the-problem"><span class="mr-2">The Problem</span><a href="#the-problem" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The particular challenge with Angular is that the build output is not the same file name every time - you can’t just swap in a new file with the proper values. See screenshot for th <code class="language-plaintext filepath highlighter-rouge">main.js</code> files from two builds:</p><p><img data-src="/assets/screenshots/2021-06-17-angular-tokenization/main.js.png" alt="main.js example" class="shadow" data-proofer-ignore> <em>Compiled main.js output from two different builds</em></p><h2 id="solution-and-file-edits"><span class="mr-2">Solution and File Edits</span><a href="#solution-and-file-edits" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>We are going to make a few modifications and additions to the Angular code, but most of the changes will come in the pipeline.</p><p>Pre-requisites:</p><ul><li><a href="https://marketplace.visualstudio.com/items?itemName=qetza.replacetokens">Qetza’s Replace Tokens</a> extension installed in the Azure DevOps organization</ul><h3 id="angularjson"><span class="mr-2">angular.json</span><a href="#angularjson" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Your <code class="language-plaintext filepath highlighter-rouge">angular.json</code> file might look a little different, but what I did was take an existing configuration, copy/paste it, and change the <code class="language-plaintext highlighter-rouge">fileReplacements</code> section, specifically the <code class="language-plaintext filepath highlighter-rouge">src/environments/environment.tokenized.ts</code> line.</p><div file="angular.json" class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="angular.json"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="w">          </span><span class="nl">"configurations"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="err">...</span><span class="w">
            </span><span class="nl">"tokenized"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"fileReplacements"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
                </span><span class="nl">"replace"</span><span class="p">:</span><span class="w"> </span><span class="s2">"src/environments/environment.ts"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"with"</span><span class="p">:</span><span class="w"> </span><span class="s2">"src/environments/environment.tokenized.ts"</span><span class="w">
              </span><span class="p">}],</span><span class="w">
              </span><span class="nl">"optimization"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
              </span><span class="nl">"outputHashing"</span><span class="p">:</span><span class="w"> </span><span class="s2">"all"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"sourceMap"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
              </span><span class="nl">"namedChunks"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
              </span><span class="nl">"extractLicenses"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
              </span><span class="nl">"vendorChunk"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
              </span><span class="nl">"buildOptimizer"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
              </span><span class="nl">"budgets"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
                  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"initial"</span><span class="p">,</span><span class="w">
                  </span><span class="nl">"maximumWarning"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2mb"</span><span class="p">,</span><span class="w">
                  </span><span class="nl">"maximumError"</span><span class="p">:</span><span class="w"> </span><span class="s2">"4mb"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="p">{</span><span class="w">
                  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"anyComponentStyle"</span><span class="p">,</span><span class="w">
                  </span><span class="nl">"maximumWarning"</span><span class="p">:</span><span class="w"> </span><span class="s2">"100kb"</span><span class="p">,</span><span class="w">
                  </span><span class="nl">"maximumError"</span><span class="p">:</span><span class="w"> </span><span class="s2">"150kb"</span><span class="w">
                </span><span class="p">}</span><span class="w">
              </span><span class="p">]</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><h2 id="environmentstokenizedts"><span class="mr-2">environments.tokenized.ts</span><a href="#environmentstokenizedts" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Similarly, I copied an existing <code class="language-plaintext filepath highlighter-rouge">src/environments/environments.*.ts</code> file to create the <code class="language-plaintext filepath highlighter-rouge">environments.tokenized.ts</code> file that my new configuration will use. The important line here is the <code class="language-plaintext highlighter-rouge">baseUrl: '#{baseUrl}#'</code> line. Notice how I’m creating a token here with the <code class="language-plaintext highlighter-rouge">#{token-name}#</code> syntax. This is the syntax of the token that our deployment process will know to find and replace.</p><div file="environments.tokenized.ts" class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="environments.tokenized.ts"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">import</span> <span class="p">{</span> <span class="nx">NgxLoggerLevel</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">ngx-logger</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">environment</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">production</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">baseUrl</span><span class="p">:</span> <span class="dl">'</span><span class="s1">#{baseUrl}#</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">webUrl</span><span class="p">:</span> <span class="nx">location</span><span class="p">.</span><span class="nx">origin</span><span class="p">,</span>
  <span class="na">loggerLevel</span><span class="p">:</span> <span class="nx">NgxLoggerLevel</span><span class="p">.</span><span class="nx">OFF</span>
<span class="p">};</span>
</pre></table></code></div></div><h2 id="azure-pipelinesyml"><span class="mr-2">azure-pipelines.yml</span><a href="#azure-pipelinesyml" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Finally, we just need to modify our pipeline file! I’ll break down the changes in chunks.</p><h3 id="1-npm-build"><span class="mr-2">1. NPM Build</span><a href="#1-npm-build" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>In the Build job, update the <strong><a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/artifacts/npm?view=azure-devops&amp;tabs=yaml">NPM build</a></strong> command. In this example, the command this task will produce will be <code class="language-plaintext highlighter-rouge">npm run build -- --prod --configuration=tokenized</code>. Alternatively, you may just opt to use a <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/yaml-schema?view=azure-devops&amp;tabs=schema%2Cparameter-schema#script">script task</a>, but the <code class="language-plaintext highlighter-rouge">Npm@1</code> task also works.</p><div class="language-yml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">Npm@1</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s2">"</span><span class="s">npm</span><span class="nv"> </span><span class="s">build"</span>
  <span class="na">inputs</span><span class="pi">:</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">custom</span>
    <span class="na">workingDir</span><span class="pi">:</span> <span class="s">src</span>
    <span class="na">verbose</span><span class="pi">:</span> <span class="no">false</span>
    <span class="na">customCommand</span><span class="pi">:</span> <span class="s">run build -- --configuration=tokenized</span>
</pre></table></code></div></div><h3 id="2-add-variables-for-your-tokens"><span class="mr-2">2. Add Variables for your Tokens</span><a href="#2-add-variables-for-your-tokens" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>For each token you have, add a like-named <strong><a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/yaml-schema?view=azure-devops&amp;tabs=schema%2Cparameter-schema#variables">variable</a></strong>. The task uses the variable name/value to find/replace in the tokenized file. Here’s an example of setting a variable at the stage level (ie: Deploy to Dev), but the variable could also be scoped at the job level. Just note that the variable is created without the <code class="language-plaintext highlighter-rouge">#{</code> prefix or <code class="language-plaintext highlighter-rouge">}#</code> suffix - in other words, just create the variable as the token name without the wrappings.</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s">deployDev</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Deploy</span><span class="nv"> </span><span class="s">Dev"</span>
  <span class="na">variables</span><span class="pi">:</span>
    <span class="na">baseUrl</span><span class="pi">:</span> <span class="s">https://mysite-dev.azurewebsites.net/</span>
</pre></table></code></div></div><h3 id="3-extract-files"><span class="mr-2">3. Extract Files</span><a href="#3-extract-files" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>I’m assuming your build artifacts are <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/yaml-schema?view=azure-devops&amp;tabs=schema%2Cparameter-schema#publish">published to the Pipeline</a>, which is going to create a zip. In the Deployment job, we need to <strong><a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/utility/extract-files?view=azure-devops">unzip the artifact</a></strong> before we can inject the real values in place of the tokens.</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">ExtractFiles@1</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Extract</span><span class="nv"> </span><span class="s">files'</span>
  <span class="na">inputs</span><span class="pi">:</span>
    <span class="na">archiveFilePatterns</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(pipeline.workspace)/**/*.zip'</span>
    <span class="na">destinationFolder</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Pipeline.Workspace)/deploy'</span>
</pre></table></code></div></div><ul><li>Unzip Note 1: If you are running on your own ubuntu agents, make sure <code class="language-plaintext highlighter-rouge">unzip</code> is installed first!<li>Unzip Note 2: Similarly, if you are running on your own agents, the above example requires the <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/phases?view=azure-devops&amp;tabs=yaml#workspace">workspace to be cleaned</a> for each run otherwise on the second run it will find more than one <code class="language-plaintext filepath highlighter-rouge">.zip</code> file to extract. You could alternatively use a stronger typed pattern than the <code class="language-plaintext filepath highlighter-rouge">**/*.zip</code> pattern in finding your zips, of course.</ul><h3 id="4-replace-tokens"><span class="mr-2">4. Replace Tokens</span><a href="#4-replace-tokens" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Right after you extract the contents of the artifact zip, add in the <strong><a href="https://marketplace.visualstudio.com/items?itemName=qetza.replacetokens">Replace Tokens</a></strong> task. Note how my <code class="language-plaintext highlighter-rouge">rootDirectory</code> parameter is the same as the <code class="language-plaintext highlighter-rouge">destinationFolder</code> parameter from the unzip task. Additionally, <code class="language-plaintext highlighter-rouge">targetFiles</code> parameter is using a pattern to find the <code class="language-plaintext filepath highlighter-rouge">main*.js</code> file, no matter what the file gets named for each build.</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">qetza.replacetokens.replacetokens-task.replacetokens@3</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Replace</span><span class="nv"> </span><span class="s">tokens'</span>
  <span class="na">inputs</span><span class="pi">:</span>
    <span class="na">rootDirectory</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(pipeline.workspace)/deploy'</span>
    <span class="na">targetFiles</span><span class="pi">:</span> <span class="s1">'</span><span class="s">**/main*.js'</span>
    <span class="na">escapeType</span><span class="pi">:</span> <span class="s">none</span>
    <span class="na">verbosity</span><span class="pi">:</span> <span class="s">detailed</span>
</pre></table></code></div></div><ul><li>Replace Tokens Note 1: Normally I don’t use the <em>full</em> name when referencing pipeline tasks, but if you also have <a href="https://marketplace.visualstudio.com/items?itemName=colinsalmcorner.colinsalmcorner-buildtasks">Colin’s ALM Corner Build and Release Tools</a>, you’ll run into an ambiguous task name error.<li>Replace Tokens Note 2: If you opted to not use the default token prefix/suffix like <code class="language-plaintext highlighter-rouge">#{token-name}#</code>, you can add in the <code class="language-plaintext highlighter-rouge">tokenPrefix</code> and <code class="language-plaintext highlighter-rouge">tokenSuffix</code> parameters here as well. Further documentation is <a href="https://github.com/qetza/vsts-replacetokens-task">here</a>.<li>Replace Tokens Note 3: If you had tokens in other <code class="language-plaintext filepath highlighter-rouge">.js</code> files, you could simply use a <code class="language-plaintext filepath highlighter-rouge">**/*.js</code> pattern.</ul><h3 id="5-azure-web-app-deploy"><span class="mr-2">5. Azure Web App Deploy</span><a href="#5-azure-web-app-deploy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Assuming your deploying this <strong><a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/deploy/azure-rm-web-app?view=azure-devops">Web App to Azure</a></strong>, update your task to use the new folder location <em>instead</em> of the zip package. The input takes either a zip or a folder, so we could have zipped our folder back up after running the replace tokens task, but there is no need. We simply need to use the same path for <code class="language-plaintext highlighter-rouge">package</code> that we used above for <code class="language-plaintext highlighter-rouge">destinationFolder</code> and <code class="language-plaintext highlighter-rouge">rootDirectory</code>.</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">AzureWebApp@1</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Deploy</span><span class="nv"> </span><span class="s">Azure</span><span class="nv"> </span><span class="s">Web</span><span class="nv"> </span><span class="s">App'</span>
  <span class="na">inputs</span><span class="pi">:</span>
    <span class="na">azureSubscription</span><span class="pi">:</span> <span class="s">MyAzureSubscription</span>
    <span class="na">appType</span><span class="pi">:</span> <span class="s1">'</span><span class="s">webAppLinux'</span>
    <span class="na">appName</span><span class="pi">:</span> <span class="s">WebAppName</span>
    <span class="na">package</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Pipeline.Workspace)/deploy'</span>
</pre></table></code></div></div><h2 id="summary"><span class="mr-2">Summary</span><a href="#summary" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The <strong>build job</strong> will use our <code class="language-plaintext highlighter-rouge">tokenized</code> configuration to run the build and use our <code class="language-plaintext highlighter-rouge">#{baseUrl}#</code> token to use when compiling instead of a Dev or Prod URL. When you build locally, you can still use whatever other configuration you want without having to worry about the tokenized value. Just be sure to keep your config in sync, that is if you add or change something to one <code class="language-plaintext filepath highlighter-rouge">environment*.ts</code> file, make sure to remember to do the tokenized one as well.</p><p>The <strong>deployment job</strong> will…</p><ul><li>take your published artifact zip from build<li>extract it<li>use the variable with the same name as the token to inject the value in for the right deployment environment<li>deploy your web app like normal!<li>rinse and repeat for all of your environments</ul><p><img data-src="/assets/screenshots/2021-06-17-angular-tokenization/replace-tokens.png" alt="Replace Tokens Workflow" class="shadow" data-proofer-ignore> <em>Replace Tokens output in the pipeline</em></p><h2 id="build-configuration--file-replacement-update-08122021"><span class="mr-2">Build Configuration / File Replacement Update 08/12/2021</span><a href="#build-configuration--file-replacement-update-08122021" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>I saw this in an <code class="language-plaintext filepath highlighter-rouge">angular.json</code> file and had to update this post. This might be a more elegant solution than creating an entirely new <code class="language-plaintext highlighter-rouge">tokenized</code> build configuration:</p><div file="angular.json" class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="angular.json"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="w">          </span><span class="nl">"configurations"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"production"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"fileReplacements"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="p">{</span><span class="w">
                  </span><span class="nl">"replace"</span><span class="p">:</span><span class="w"> </span><span class="s2">"apps/My-Angular-App/src/environments/environment.ts"</span><span class="p">,</span><span class="w">
                  </span><span class="nl">"with"</span><span class="p">:</span><span class="w"> </span><span class="s2">"apps/My-Angular-App/src/environments/environment.prod.ts"</span><span class="w">
                </span><span class="p">}</span><span class="w">
              </span><span class="p">],</span><span class="w">
              </span><span class="err">...</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>This encapsulates the best of both worlds - we are still building once and deploying many, but we also don’t need a specialized build configuration to run through. We can use the normal production build configuration and file replace the tokenized <code class="language-plaintext filepath highlighter-rouge">environments.prod.ts</code> with <code class="language-plaintext filepath highlighter-rouge">environment.ts</code> at build time.</p><p>The deployment replace tokens task will replace the tokens with the proper environment-specific variable configuration.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/azure-devops/'>Azure DevOps</a>, <a href='/categories/pipelines/'>Pipelines</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/azure-devops/" class="post-tag no-text-decoration" >Azure DevOps</a> <a href="/tags/pipelines/" class="post-tag no-text-decoration" >Pipelines</a> <a href="/tags/angular/" class="post-tag no-text-decoration" >Angular</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Tokenizing+Angular+Environment+Configuration+in+Azure+DevOps+-+josh-ops&url=https%3A%2F%2Fjosh-ops.com%2Fposts%2Fangular-tokenization%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Tokenizing+Angular+Environment+Configuration+in+Azure+DevOps+-+josh-ops&u=https%3A%2F%2Fjosh-ops.com%2Fposts%2Fangular-tokenization%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fjosh-ops.com%2Fposts%2Fangular-tokenization%2F&text=Tokenizing+Angular+Environment+Configuration+in+Azure+DevOps+-+josh-ops" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fjosh-ops.com%2Fposts%2Fangular-tokenization%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/github-container-jobs/">Docker Container Jobs in GitHub Actions</a><li><a href="/posts/actions-runner-controller-without-cert-manager/">Configure actions-runner-controller without cert-manager</a><li><a href="/posts/azdo-commit-message-validator-and-pr-linker-github-action/">Azure DevOps Commit Message Validator and PR Linker GitHub Action</a><li><a href="/posts/azure-devops-migrate-work-items/">Azure DevOps: Migrate Work Items to New Organization / Project</a><li><a href="/posts/github-misc-scripts/">Miscellaneous GitHub API/GraphQL/CLI Automation Scripts</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/github/">GitHub</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/github-actions/">GitHub Actions</a> <a class="post-tag" href="/tags/pull-requests/">Pull Requests</a> <a class="post-tag" href="/tags/github-advanced-security/">GitHub Advanced Security</a> <a class="post-tag" href="/tags/scripts/">Scripts</a> <a class="post-tag" href="/tags/work-items/">Work Items</a> <a class="post-tag" href="/tags/branch-protection-rules/">Branch Protection Rules</a> <a class="post-tag" href="/tags/dependabot/">Dependabot</a> <a class="post-tag" href="/tags/codeql/">CodeQL</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/azdo-angular-pipeline-caching/"><div class="card-body"> <em class="small" data-ts="1636943400" data-df="ll" > Nov 14, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Working Azure DevOps Pipeline Caching for Angular CI</h3><div class="text-muted small"><p> Overview I’ve tried several times to implement the Pipeline Cache task using Microsoft’s documentation, but have failed every time. I seemed to configure everything like the documentation indicate...</p></div></div></a></div><div class="card"> <a href="/posts/pipeline-templates/"><div class="card-body"> <em class="small" data-ts="1628827200" data-df="ll" > Aug 12, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Azure DevOps: Pipeline Templates</h3><div class="text-muted small"><p> Overview Although linked in various posts in this blog, I never fully advertise my pipeline-templates GitHub repository. I refer back to this every so often to see how I accomplished something in ...</p></div></div></a></div><div class="card"> <a href="/posts/agent-pool-error/"><div class="card-body"> <em class="small" data-ts="1629291600" data-df="ll" > Aug 18, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Azure DevOps: No agent pool found with identifier xx</h3><div class="text-muted small"><p> Overview We are using the Virtual Machine Scale Set (VMSS) Azure DevOps agents pretty heavily. They are perfect for our situation, needing to be able to deploy to services locked down by private e...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/trac-to-github/" class="btn btn-outline-primary" prompt="Older"><p>So You Want to Migrate Trac Tickets to GitHub Issues</p></a> <a href="/posts/azdo-delete-custom-field/" class="btn btn-outline-primary" prompt="Newer"><p>Azure DevOps: Delete Custom Fields on Process Template</p></a></div><script src="https://utteranc.es/client.js" repo="joshjohanning/joshjohanning.github.io" issue-term="title" crossorigin="anonymous" async> </script> <script type="text/javascript"> $(function() { const origin = "https://utteranc.es"; const iframe = "iframe.utterances-frame"; const lightTheme = "github-light"; const darkTheme = "github-dark"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } addEventListener("message", (event) => { let theme; /* credit to <https://github.com/utterance/utterances/issues/170#issuecomment-594036347> */ if (event.origin === origin) { /* page initial */ theme = initTheme; } else if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); } else { return; } const message = { type: "set-theme", theme: theme }; const utterances = document.querySelector(iframe).contentWindow; utterances.postMessage(message, origin); }); }); </script></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/joshjohanning">Josh Johanning</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/github/">GitHub</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/github-actions/">GitHub Actions</a> <a class="post-tag" href="/tags/pull-requests/">Pull Requests</a> <a class="post-tag" href="/tags/github-advanced-security/">GitHub Advanced Security</a> <a class="post-tag" href="/tags/scripts/">Scripts</a> <a class="post-tag" href="/tags/work-items/">Work Items</a> <a class="post-tag" href="/tags/branch-protection-rules/">Branch Protection Rules</a> <a class="post-tag" href="/tags/dependabot/">Dependabot</a> <a class="post-tag" href="/tags/codeql/">CodeQL</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-GE92ZJY22K"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-GE92ZJY22K'); }); </script>
